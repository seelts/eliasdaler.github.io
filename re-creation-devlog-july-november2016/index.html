<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://eliasdaler.github.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><link rel=me href=https://mastodon.gamedev.place/web/@eliasdaler><link rel=alternate type=application/rss+xml href=https://eliasdaler.github.io/feed.xml title="Elias Daler's blog"><title>Re:creation dev log. July - November 2016</title></head><body><header id=banner><h2><a href=https://eliasdaler.github.io>Elias Daler's blog</a></h2><nav><ul></ul></nav></header><main id=content><article><header id=post-header><h1>Re:creation dev log. July - November 2016</h1><div>Publication date: <time>November 27, 2016</time></div><div></div></header><p>The last five months were really important for the game. It finally feels like I can work on the game itself now, not just the engine and basic systems which will let me implement different stuff in the game. It&rsquo;s not just abstract stuff, stuff which I do &ldquo;just in case&rdquo;. No, I try to be pragmatic and implement things which are needed for the game and which will let me create stuff without much restrictions.</p><p>I&rsquo;m very glad to say this, but I feel like the core engine is almost done. There are still some important things which I&rsquo;ll have to implement, but it still feels like I&rsquo;m finally happy with the design I have. Mostly, it&rsquo;s because I&rsquo;ve removed lots of stuff and find lots of ways to minimize my code which in the end gives me ability to implement new stuff easier and makes the whole thing easier to expand, modify and debug.</p><p>I&rsquo;m finally ready to do a lot of prototyping. I&rsquo;ve already done a lot of stuff about the game, but I still have the feeling that it&rsquo;s just the beginning of the &ldquo;real&rdquo; development! And it feels great, because I feel like I&rsquo;m in total control of every aspect of the game. There are no restrictions, no boundaries. Let&rsquo;s see how it goes.</p><p>One more small thing: I&rsquo;ve got a new laptop! I&rsquo;ve had it for two weeks now. It feels really great. I&rsquo;m able to do stuff a lot quicker and without frustration (having a great mood is important to be productive)! I&rsquo;ve had my previous laptop for six years and it was slowing me down a lot. It was constantly overheating, everything was running poorly, compilation took a long time, etc&mldr; And recently I&rsquo;ve realized how much it hurt my working process. There were lots of distractions, because even small change could take 1-2 minutes of recompilation. This means, that fast iteration was impossible. This also means that I constantly lost flow and couldn&rsquo;t debug quickly. Hours of slow progress made it all exhausting. Won&rsquo;t happen anymore!</p><p>Okay, let&rsquo;s begin!</p><h1 id=art>Art</h1><p>I haven&rsquo;t done much art in the last months and most of the stuff I&rsquo;ve done is still not finished, so I&rsquo;ll show them a bit later. There&rsquo;s a next graphics improvement coming and I&rsquo;m glad that I didn&rsquo;t have a lot of graphics done, because I&rsquo;d have to redraw tons of stuff. Let&rsquo;s hope it will be the last huge change!</p><p>I&rsquo;ve improved Renatus&rsquo; design and walking animation, it&rsquo;s nice to see how much my art improved over time:
<img src=walk-animations.gif alt="Re:cration walk cycles"></p><p>I&rsquo;ve also made some very small, but cool things&mldr;
Unsynched idle animations make everything look more alive!
<img src=torches.gif alt=Torches></p><p>Cat doesn&rsquo;t &ldquo;talk&rdquo; during &ldquo;translation&rdquo;
<img src=cat-talk.gif alt="Cat speaking"></p><h1 id=multiple-tilemaps-in-one-level>Multiple tilemaps in one level</h1><p>Previously the level was limited to one tile map. That meant that if I wanted to make indoor places I either had to switch to another level (which isn&rsquo;t fast!) or place the indoor area somewhere far away and teleport the player there. The second approach is highly used in 3d games, but I&rsquo;ve realized that it wasn&rsquo;t as good in 2d tile-based games because it&rsquo;s harder to move tiles and you have to account for empty areas in your tilemap which are created by placing some area far away.</p><p>Eventually, I&rsquo;ve made a decision to make levels which support multiple tilemaps. It wasn&rsquo;t easy to make, because lots of assumptions were made about Level having only one tilemap, but fortunately it wasn&rsquo;t that bad, so I&rsquo;ve done it fairly quickly. Now I can easily switch tilemaps during the fade in / fade out effect during scene transitions.</p><h1 id=input>Input</h1><p>Previously I&rsquo;ve used polling for input, but realized that events are a lot more efficient and let me easily move all the input in Lua! One more part of game logic moved from C++ to Lua again! Great.</p><p>I&rsquo;ve also made much better system for input in general. Now all keys can be mapped to &ldquo;actions&rdquo; or &ldquo;axes&rdquo; (plural of &ldquo;axis&rdquo;, not &ldquo;axe&rdquo;!). &ldquo;Actions&rdquo; and &ldquo;Axes&rdquo; can be binded to C++ or Lua callback. This makes low-level input decoupled from game input logic in a nice way.</p><p>One advantage of event based scripting is being able to set only one callback for particular action at given time. For example, during dialogues the &ldquo;Primary Action&rdquo; input action will be assigned to &ldquo;Skip dialogue&rdquo;, not &ldquo;Attack/Use Primary Item&rdquo;, so I don&rsquo;t have to worry that somehow the player will be able to attack during dialogues.</p><p>My input manager now also has complete gamepad support (sticks and triggers are also supported and it&rsquo;s possible to connect gamepad in-game!). Event based input will later make it easy to implement replay system which will just send input events at needed times, simulating real player pressing buttons. Easy to implement and very useful for debugging!</p><h1 id=moved-entity-states-from-c-to-lua>Moved Entity states from C++ to Lua</h1><p>This is a thing that I wanted to make for a long time. Basically, most of the game logic lives in entity states. State like <code>MoveState</code>, <code>AttackState</code>, etc. Previously they were hard-coded in C++ which made them hard to modify and control with Lua. Another problem was that the more stuff I added to Lua, the harder it became for me to access stuff one Lua side.</p><p>For example, once I&rsquo;ve implemented Action Lists in Lua, I&rsquo;ve realized that some entity states can highly benefit from using them. But this meant that a lot of calls between Lua and C++ would happen.</p><p>Rewriting entity states was extremely easy and I&rsquo;ve discovered and fixed a lot of bugs along the way. I&rsquo;ve also made entity states a lot more reusable, so that different entities can use the same code while adding bits that are different. For example, the same AttackState is used by player character, enemies with melee weapons and archers!</p><p>Action lists are used to make code much easier to follow, basically the lists goes like this:</p><ul><li>Pre-attack animation (starting to swing a sword / aiming the arrow)</li><li>Attack animation (continuing to swing a sword / shooting the arrow)
During this step the damage is created during some frame. For melee attackers it&rsquo;s defined in their AttackComponent, for archer the damage is &ldquo;arrow&rdquo; entity which is created on the first frame of &ldquo;shoot&rdquo; animation</li><li>Post attack animation</li></ul><p>I&rsquo;ve also implemented multiple state machines for entities. Most of the time the entity will have only one state machine which will describe it&rsquo;s &ldquo;main&rdquo; state, but sometimes it&rsquo;s useful to have another state machine which will, for example, describe it&rsquo;s health state, so that if the entity has low health, it will play different &ldquo;idle&rdquo; animation.</p><h1 id=private-messages-in-event-system>Private messages in event system</h1><p>I&rsquo;ve effectively used event system with global queue for quite some time, but then I&rsquo;ve realized that it&rsquo;s not efficient for some events to be implemented that way. One example of this is collision callbacks. When two entities collide, each entity&rsquo;s onCollide function needs to be called with some additional info about which entity collided with it and maybe how it happened. In global queue each entity interested in collision event would receive this event and it would have to check if the collision happened with it or not. Of course that&rsquo;s a huge waste of time, so that&rsquo;s why I&rsquo;ve made &ldquo;private message&rdquo; system which let&rsquo;s entities specify sender and receiver for each event and then EventManager just sends this event to receiver object.</p><h1 id=improved-dialogues-a-lot>Improved dialogues a lot</h1><p>Dialogue system got some needed improvements! One such improvement is ability to insert delays and even function calls between words! It looks like this in a text:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:navy>&#34;SOME_TEXT_TAG&#34;</span> : <span style=color:#b84>&#34;Hello...[DELAY 500][X] I&#39;ve been waiting for you&#34;</span>}
</span></span></code></pre></div><p><code>[DELAY 500]</code> creates a 500 ms delay. <code>[X]</code> indicates that the function with tag &ldquo;X&rdquo; will be called. In scripts, it looks something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>DialogueAction {
</span></span><span style=display:flex><span>    text <span style=font-weight:700>=</span> {<span style=color:#b84>&#34;SOME_TEXT_TAG&#34;</span>},
</span></span><span style=display:flex><span>    functions <span style=font-weight:700>=</span> {
</span></span><span style=display:flex><span>        x <span style=font-weight:700>=</span> <span style=font-weight:700>function</span>(talker)
</span></span><span style=display:flex><span>            talker:setAnimation(<span style=color:#b84>&#34;smile&#34;</span>)
</span></span><span style=display:flex><span>        <span style=font-weight:700>end</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I later plan to add shaking or wave effects to text for better expression of characters&rsquo; emotions.</p><h1 id=dev-tools>Dev tools</h1><p>I&rsquo;ve made some useful in-game dev tools with ImGui. One such tool is in-game console which lets me execute Lua easily. Here&rsquo;s a little demo of it in action!
<img src=lua-console.gif alt="Lua console"></p><p>I&rsquo;ve also made a tool for controlling time. Now it&rsquo;s possible to slow down and pause the game at any moment. The game doesn&rsquo;t slow down or stop, I just change deltaTime, so I can easily debug everything in Visual Studio.
<img src=time-control.gif alt="Time control"></p><h1 id=removed-tons-of-components>Removed tons of components</h1><p>I&rsquo;ve also removed a lot of components which I found redundant and easily made with other components which have much larger role. Here&rsquo;s what I&rsquo;ve removed.</p><h2 id=direction-component>Direction Component</h2><p>Direction component stored just one thing: entity&rsquo;s direction. But that meant that to access entity&rsquo;s direction I had to get DirectionComponent and then get the direction. Getting component from entity isn&rsquo;t very fast (because it involves a <code>dynamic_cast</code> and <code>std::unordered_map</code> search) so I&rsquo;ve just started to store entity&rsquo;s direction in Entity class. Yes, some entities won&rsquo;t have a direction (invisible entities or trees, for example), but I just assign <code>Direction::None</code> to them. Storing 1 additional byte inside of Entity isn&rsquo;t a big deal!</p><h2 id=trigger-component>Trigger Component</h2><p>I&rsquo;ve also removed trigger component. Previously it was used for triggers and made possible to realize the following callbacks: <code>onEnter</code>, <code>onStay</code> and <code>onExit</code>. But how did I check when to call them? I checked if trigger collides with potentially interesting entities or not&mldr; but then I&rsquo;ve realized: why not just use <code>CollisionComponent</code> for that and make a simple entity state machine which will track entities state which are: Idle or Triggered. OnEnter is called on transition from Idle to Triggered state, onStay is called when Triggered state is active and onExit is called during transition from Triggered to Idle state. <code>CollisionEnter</code> and <code>CollisionExit</code> events trigger state transitions. This means that TriggerComponent wasn&rsquo;t needed anymore and I got rid of it with a huge satisfaction.</p><p>I&rsquo;ve also made &ldquo;directed&rdquo; triggers which are called only when the player faces the specific direction, for example cafe has a trigger which lets player exit it when his direction is &ldquo;Down&rdquo;.</p><h2 id=interaction-component>Interaction Component</h2><p>Interaction Component was used for player-entity interactions, for example speaking with NPCs. When the player enters the &ldquo;interaction area&rdquo;, the input changes and pressing a specific button will start dialogue. Hmmm&mldr; seems familiar, isn&rsquo;t it? Yes, this component isn&rsquo;t needed too, because I can just make a trigger which will just change the input during onEnter/onExit function calls. Using it with &ldquo;directed&rdquo; triggers makes it perfect, because now it&rsquo;s easy to make interaction possible only when the player faces the entity. (Previously it was possible to talk with NPCs while turning away from them, not cool!)</p><h1 id=remade-damage-system>Remade damage system</h1><p>Previously when player attacked, the &ldquo;damage&rdquo; entity was created and then destroyed. If something collided with it, the damage was registered. But on one random forum I&rsquo;ve found much better solution: just have &ldquo;damage&rdquo; rect with melee attackers all the time and activate it only during attack. Simple and much more efficient!</p><h1 id=sat-separating-axis-theorem-collision>SAT (Separating Axis Theorem) collision</h1><p>After a lot of trying and failing, I&rsquo;ve implemented SAT collision detection and response which will be used for some complex level geometry.
<img src=sat.gif alt="SAT in action"></p><p>I&rsquo;ve put my SAT implementation <a href=https://gist.github.com/eliasdaler/502b54fcf1b515bcc50360ce874e81bc>here</a>. Feel free to use it for your projects!</p><h1 id=refactoring>Refactoring</h1><p>I&rsquo;ve also done <strong>a lot</strong> of refactoring. I&rsquo;m mostly satisfied with most of my codebase, but there was some bad stuff that I needed to fix once and for all!
Mostly, I&rsquo;ve been fixing pretty typical problems: unnecessary dependencies, some code duplication, problems with ownerships, etc. Not too much to say about that!
But the good thing about refactoring is that it just made my codebase a lot shorter. At some point it&rsquo;s not a refactoring anymore, it&rsquo;s restructuring, implementing better code, moving some stuff to Lua, etc.</p><p><strong>C++</strong>: -4345 lines of code</p><p><strong>Lua</strong>: +540 lines of code</p><p><strong>Total</strong>: -3814 lines of code</p><p>This makes me extremely happy, because shorter and cleaner code is much easier to manage and improve. Writing negative code feels great!</p><h1 id=conclusion>Conclusion</h1><p>The last few months were very important and productive! While there wasn&rsquo;t a huge progress about the game itself, the engine is almost done, I&rsquo;m very happy with the code and engine structure now. The next few months will be spent prototyping and making &ldquo;vertical slice&rdquo; of the game and I hope I&rsquo;ll be able to make game truly fun and enjoyable. See ya!</p></article></main><footer id=footer>© 2022 Elias Daler. All rights reserved.<p>subscribe via <a href=https://eliasdaler.github.io/feed.xml>RSS</a></p></footer></body></html>